!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.RtcPhone=t():e.RtcPhone=t()}(window,function(){return function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="./",i(i.s=1)}([function(e,t,i){"use strict";var s=Object.prototype.hasOwnProperty,n="~";function o(){}function a(e,t,i,s,o){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new function(e,t,i){this.fn=e,this.context=t,this.once=i||!1}(i,s||e,o),r=n?n+t:t;return e._events[r]?e._events[r].fn?e._events[r]=[e._events[r],a]:e._events[r].push(a):(e._events[r]=a,e._eventsCount++),e}function r(e,t){0==--e._eventsCount?e._events=new o:delete e._events[t]}function l(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(n=!1)),l.prototype.eventNames=function(){var e,t,i=[];if(0===this._eventsCount)return i;for(t in e=this._events)s.call(e,t)&&i.push(n?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},l.prototype.listeners=function(e){var t=n?n+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var s=0,o=i.length,a=new Array(o);s<o;s++)a[s]=i[s].fn;return a},l.prototype.listenerCount=function(e){var t=n?n+e:e,i=this._events[t];return i?i.fn?1:i.length:0},l.prototype.emit=function(e,t,i,s,o,a){var r=n?n+e:e;if(!this._events[r])return!1;var l,c,p=this._events[r],d=arguments.length;if(p.fn){switch(p.once&&this.removeListener(e,p.fn,void 0,!0),d){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,t),!0;case 3:return p.fn.call(p.context,t,i),!0;case 4:return p.fn.call(p.context,t,i,s),!0;case 5:return p.fn.call(p.context,t,i,s,o),!0;case 6:return p.fn.call(p.context,t,i,s,o,a),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];p.fn.apply(p.context,l)}else{var h,u=p.length;for(c=0;c<u;c++)switch(p[c].once&&this.removeListener(e,p[c].fn,void 0,!0),d){case 1:p[c].fn.call(p[c].context);break;case 2:p[c].fn.call(p[c].context,t);break;case 3:p[c].fn.call(p[c].context,t,i);break;case 4:p[c].fn.call(p[c].context,t,i,s);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];p[c].fn.apply(p[c].context,l)}}return!0},l.prototype.on=function(e,t,i){return a(this,e,t,i,!1)},l.prototype.once=function(e,t,i){return a(this,e,t,i,!0)},l.prototype.removeListener=function(e,t,i,s){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return r(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||s&&!a.once||i&&a.context!==i||r(this,o);else{for(var l=0,c=[],p=a.length;l<p;l++)(a[l].fn!==t||s&&!a[l].once||i&&a[l].context!==i)&&c.push(a[l]);c.length?this._events[o]=1===c.length?c[0]:c:r(this,o)}return this},l.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&r(this,t)):(this._events=new o,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=n,l.EventEmitter=l,e.exports=l},function(e,t,i){"use strict";i.r(t);var s=i(0),n=i.n(s);var o={showMessage(e){alert(e)},checkPhoneNumber(e){if(null==e||0===e.length)return!1;{let t="*#0123456789";if(0===(e=this.trim(e)).indexOf("ivr_"))return!0;for(let i=0;i<e.length;i++){let s=e.charAt(i);if(-1===t.indexOf(s))return this.showMessage("输入的电话号码不符合规范,请检查是否含有空格或者其他非数字字符."),!1}return!0}},getSearchParamVal(e){for(var t=window.location.search.substring(1).split("&"),i=0;i<t.length;i++){var s=t[i].split("=");if(decodeURIComponent(s[0])===e)return decodeURIComponent(s[1])}return null},parseParam(e){let t=[];return e&&Object.keys(e).forEach(function(i){t.push(`${encodeURIComponent(i)}=${encodeURIComponent(e[i])}`)}),t.join("&")},isFunction:e=>"function"==typeof e,firstUpperCase:e=>e.replace(/( |^)[a-z]/g,e=>e.toUpperCase()),trim:e=>e.replace(/(^\s*)|(\s*$)/g,"")};var a=class{static log(e,...t){console.log(e,...t)}static info(e,...t){console.info(e,...t)}static error(e,...t){console.error(e,...t)}};class r extends n.a{constructor({webRtcType:e="native",pfs:t,maxVideoSize:i,maxBandwidthUp:s,maxBandwidthDown:n,zeroArtifacts:r,startNativeDebug:l=!1,ringToneDom:c,ringbackToneDom:p,audioRemoteDom:d,videoLocalDom:h,videoRemoteDom:u,onInitialized:m,onStackStartFailed:f,onConnected:g,onDisconnected:S,onRinging:_,onDialing:b,onTalking:w,onReleased:v}){if(super(),"complete"!==document.readyState)throw"Dom not ready !";if(a.info(`RtcPhone Constructor:location=${window.location}`),SIPml.setDebugLevel(window.localStorage&&"true"==window.localStorage.getItem("org.doubango.expert.disable_debug")?"error":"info"),SIPml.setWebRtcType(e),t&&SIPml.setFps(t),i&&SIPml.setMaxVideoSize(i),s&&SIPml.setMaxBandwidthUp(s),n&&SIPml.setMaxBandwidthDown(n),r&&SIPml.setZeroArtifacts(!0===r),!0===l&&SIPml.startNativeDebug(),this.ringTone=document.getElementById(c),!this.ringTone)throw"Ringtone dom does not exist !";if(this.ringbackTone=document.getElementById(p),!this.ringbackTone)throw"RingbackTone dom does not exist !";if(this.audioRemote=document.getElementById(d),!this.audioRemote)throw"Audio dom does not exist !";if(this.videoLocal=document.getElementById(h),!this.videoLocal)throw"Local video dom does not exist !";if(this.videoRemote=document.getElementById(u),!this.videoRemote)throw"Remote video dom does not exist !";this.configCall={audio_remote:this.audioRemote,video_local:this.videoLocal,video_remote:this.videoRemote,screencast_window_id:0,bandwidth:{audio:void 0,video:void 0},video_size:{minWidth:void 0,minHeight:void 0,maxWidth:void 0,maxHeight:void 0},events_listener:{events:"*",listener:this.onSipEventSession.bind(this)},sip_caps:[{name:"+g.oma.sip-im"},{name:"language",value:'"en,fr"'}]},this.sipStack=null,this.sipSessionRegister=null,this.sipSessionCall=null,this.status="uninitialized",o.isFunction(m)&&this.on("initialized",m),o.isFunction(f)&&this.on("stackStartFailed",f),o.isFunction(g)&&this.on("connected",g),o.isFunction(S)&&this.on("disconnected",S),o.isFunction(_)&&this.on("ringing",_),o.isFunction(b)&&this.on("dialing",b),o.isFunction(w)&&this.on("talking",w),o.isFunction(v)&&this.on("released",v)}sipInit(){SIPml.init(this.postInit.bind(this))}postInit(){if(!SIPml.isWebRtcSupported()){if("chrome"==SIPml.getNavigatorFriendlyName())return void(confirm("You're using an old Chrome version or WebRTC is not enabled.\nDo you want to see how to enable WebRTC?")?window.location="http://www.webrtc.org/running-the-demos":window.location="index.html");confirm("webrtc-everywhere extension is not installed. Do you want to install it?\nIMPORTANT: You must restart your browser after the installation.")&&(window.location="https://github.com/sarandogou/webrtc-everywhere")}SIPml.isWebSocketSupported()?(SIPml.isWebRtcSupported()||confirm("Your browser don't support WebRTC.\naudio/video calls will be disabled.\nDo you want to download a WebRTC-capable browser?")&&(window.location="https://www.google.com/intl/en/chrome/browser/"),this.status="initialized",this.emit("initialized")):confirm("Your browser don't support WebSockets.\nDo you want to download a WebSocket-capable browser?")?window.location="https://www.google.com/intl/en/chrome/browser/":window.location="index.html"}sipRegister({displayName:e="",privateIdentity:t="",publicIdentity:i="",password:s="",realm:n="",websocketProxyUrl:o="wss://rtc.95ykf.com:4443"}){if("uninitialized"===this.status)return a.error("RtcPhone uninitialized!"),!1;if(this.sipSessionRegister)return a.error("RtcPhone Registered!"),!1;try{let a=tsip_uri.prototype.Parse(i);if(!a||!a.s_user_name||!a.s_host)throw"Public Identity format error !";this.realm=n,this.displayName=e,this.privateIdentity=t,this.publicIdentity=i,this.websocketProxyUrl=o,window.webkitNotifications&&0!=window.webkitNotifications.checkPermission()&&window.webkitNotifications.requestPermission(),SIPml.setDebugLevel(window.localStorage&&"true"==window.localStorage.getItem("org.doubango.expert.disable_debug")?"error":"info"),this.sipStack=new SIPml.Stack({realm:this.realm,impi:this.privateIdentity,impu:this.publicIdentity,password:s,display_name:this.displayName,websocket_proxy_url:this.websocketProxyUrl,outbound_proxy_url:window.localStorage?window.localStorage.getItem("org.doubango.expert.sip_outboundproxy_url"):null,ice_servers:[],enable_rtcweb_breaker:!!window.localStorage&&"true"==window.localStorage.getItem("org.doubango.expert.enable_rtcweb_breaker"),events_listener:{events:"*",listener:this.onSipEventStack.bind(this)},enable_early_ims:!window.localStorage||"true"!=window.localStorage.getItem("org.doubango.expert.disable_early_ims"),enable_media_stream_cache:!!window.localStorage&&"true"==window.localStorage.getItem("org.doubango.expert.enable_media_caching"),bandwidth:window.localStorage?tsk_string_to_object(window.localStorage.getItem("org.doubango.expert.bandwidth")):null,video_size:window.localStorage?tsk_string_to_object(window.localStorage.getItem("org.doubango.expert.video_size")):null,sip_headers:[{name:"User-Agent",value:"HLCC-WebRTC-Client/1.0"},{name:"Organization",value:"HL95"}]}),0!=this.sipStack.start()&&this.emit("stackStartFailed")}catch(e){this.emit("stackStartFailed",e)}}sipUnRegister(){this.sipStack&&this.sipStack.stop()}sipCall(e,t){if(!this.sipStack)return o.showMessage("UnRegister!"),!1;if(this.sipSessionCall)this.sipSessionCall.accept(this.configCall);else{if(!o.checkPhoneNumber(t))return o.showMessage("Phone number format error !"),!1;if("call-screenshare"==e){if(!SIPml.isScreenShareSupported())return o.showMessage("Screen sharing not supported. Are you using chrome 26+?"),!1;if(!location.protocol.match("https"))return o.showMessage("Screen sharing requires https://."),this.sipUnRegister(),!1}if(window.localStorage&&(this.configCall.bandwidth=tsk_string_to_object(window.localStorage.getItem("org.doubango.expert.bandwidth")),this.configCall.video_size=tsk_string_to_object(window.localStorage.getItem("org.doubango.expert.video_size"))),this.sipSessionCall=this.sipStack.newSession(e,this.configCall),0!=this.sipSessionCall.call(t))return this.sipSessionCall=null,void this.emit("callFailed")}}sipAnswer(){return this.sipStack?this.sipSessionCall?void this.sipSessionCall.accept(this.configCall):(o.showMessage("no call!"),!1):(o.showMessage("UnRegister!"),!1)}sipShareScreen(){if("w4a"===SIPml.getWebRtcType()){if(!this.sipSessionCall)return o.showMessage("No active session"),!1;this.sipSessionCall.bfcpSharing?0!=this.sipSessionCall.stopBfcpShare(this.configCall)?txtCallStatus.value="Failed to stop BFCP share":this.sipSessionCall.bfcpSharing=!1:(this.configCall.screencast_window_id=0,0!=this.sipSessionCall.startBfcpShare(this.configCall)?txtCallStatus.value="Failed to start BFCP share":this.sipSessionCall.bfcpSharing=!0)}else sipCall("call-screenshare")}sipTransfer(e){if(!this.sipSessionCall)return!1;if(!o.checkPhoneNumber(e))return!1;return 0!=this.sipSessionCall.transfer(e)?(a.error("Call transfer failed"),!1):(a.info("Transfering the call..."),!0)}sipToggleHoldResume(){if(!this.sipSessionCall)return!1;return 0==(this.sipSessionCall.bHeld?this.sipSessionCall.resume():this.sipSessionCall.hold())}sipToggleMute(){if(!this.sipSessionCall)return!1;let e=!this.sipSessionCall.bMute;return 0==this.sipSessionCall.mute("audio",e)&&(this.sipSessionCall.bMute=e,!0)}sipHangup(){this.sipSessionCall&&this.sipSessionCall.hangup({events_listener:{events:"*",listener:this.onSipEventSession.bind(this)}})}sipSendDTMF(e){this.sipSessionCall&&e&&0==this.sipSessionCall.dtmf(e)&&a.info(`sipSendDTMF ${e}`)}startRingTone(){try{ringtone.play()}catch(e){}}stopRingTone(){try{ringtone.pause()}catch(e){}}startRingbackTone(){try{ringbacktone.play()}catch(e){}}stopRingbackTone(){try{ringbacktone.pause()}catch(e){}}onSipEventStack(e){switch(a.info("==stack event = "+e.type),e.type){case"started":try{this.sipSessionRegister=this.sipStack.newSession("register",{expires:200,events_listener:{events:"*",listener:this.onSipEventSession.bind(this)},sip_caps:[{name:"+g.oma.sip-im",value:null},{name:"+audio",value:null},{name:"language",value:'"en,fr"'}]}),this.sipSessionRegister.register()}catch(e){a.error("注册失败",e)}break;case"stopping":case"stopped":case"failed_to_start":case"failed_to_stop":{let t="failed_to_start"==e.type||"failed_to_stop"==e.type;this.sipStack=null,this.sipSessionRegister=null,this.sipSessionCall=null,this.emit("disconnected"),this.stopRingbackTone(),this.stopRingTone(),a.info(t?"Disconnected: "+e.description:"Disconnected");break}case"i_new_call":if(a.info("==i_new_call_log = "+this.sipSessionCall),this.sipSessionCall)e.newSession.hangup();else{this.sipSessionCall=e.newSession,this.sipSessionCall.setConfiguration(this.configCall),this.callStatus="ringing",this.startRingTone();let t=this.sipSessionCall.getRemoteFriendlyName()||"unknown";a.info("Incoming call from "+t),this.emit("ringing",t)}break;case"m_permission_requested":a.log("=======m_permission_requested====="+e);break;case"m_permission_accepted":case"m_permission_refused":a.log("=======m_permission_accepted=m_permission_refused11====="+e)}}onSipEventSession(e){switch(a.info("==session event = "+e.type,e.description),e.type){case"connecting":e.session==this.sipSessionRegister?(this.status=e.type,this.emit(e.type,e)):e.session==this.sipSessionCall&&this.emit("session",e);break;case"connected":e.session==this.sipSessionRegister?(this.status=e.type,this.emit(e.type,e)):e.session==this.sipSessionCall&&(this.stopRingbackTone(),this.stopRingTone(),this.callStatus="talking",this.emit("talking",e));break;case"terminating":case"terminated":e.session==this.sipSessionRegister?(this.status=e.type,this.sipSessionCall=null,this.sipSessionRegister=null,this.emit("disconnected")):e.session==this.sipSessionCall&&(this.sipSessionCall=null,this.stopRingbackTone(),this.stopRingTone(),this.emit("released",e));break;case"m_stream_video_local_added":e.session==this.sipSessionCall&&this.emit("localVideoAdded");break;case"m_stream_video_local_removed":e.session==this.sipSessionCall&&this.emit("localVideoRemoved");break;case"m_stream_video_remote_added":case"m_stream_video_remote_removed":e.session,this.sipSessionCall;break;case"m_stream_audio_local_added":case"m_stream_audio_local_removed":case"m_stream_audio_remote_added":case"m_stream_audio_remote_removed":break;case"i_ect_new_call":oSipSessionTransferCall=e.session;break;case"i_ao_request":if(e.session==this.sipSessionCall){let t=e.getSipResponseCode();180!=t&&183!=t||(this.callStatus="dialing",this.emit("dialing",e),a.info("Remote ringing..."))}break;case"m_early_media":e.session==this.sipSessionCall&&(this.stopRingbackTone(),this.stopRingTone(),a.info("Early media started"));break;case"m_local_hold_ok":e.session==this.sipSessionCall&&(this.sipSessionCall.bTransfering&&(this.sipSessionCall.bTransfering=!1),this.emit("holdCompleted",e),a.info("Call placed on hold"),this.sipSessionCall.bHeld=!0);break;case"m_local_hold_nok":e.session==this.sipSessionCall&&(this.sipSessionCall.bTransfering=!1,this.emit("holdFailed",e),a.info("Failed to place remote party on hold"));break;case"m_local_resume_ok":e.session==this.sipSessionCall&&(this.sipSessionCall.bTransfering=!1,this.emit("resumeCompleted",e),a.info("Call taken off hold"),this.sipSessionCall.bHeld=!1,SIPml.isWebRtc4AllSupported());break;case"m_local_resume_nok":e.session==this.sipSessionCall&&(this.sipSessionCall.bTransfering=!1,this.emit("resumeFailed",e),a.info("Failed to unhold call"));break;case"m_remote_hold":e.session==this.sipSessionCall&&a.info("Placed on hold by remote party");break;case"m_remote_resume":e.session==this.sipSessionCall&&a.info("Taken off hold by remote party");break;case"m_bfcp_info":e.session==this.sipSessionCall&&(txtCallStatus.innerHTML="BFCP Info: <i>"+e.description+"</i>");break;case"o_ect_trying":e.session==this.sipSessionCall&&a.info("Call transfer in progress...");break;case"o_ect_accepted":e.session==this.sipSessionCall&&a.info("Call transfer accepted");break;case"o_ect_completed":case"i_ect_completed":e.session==this.sipSessionCall&&(a.info("Call transfer completed"),oSipSessionTransferCall&&(this.sipSessionCall=oSipSessionTransferCall),oSipSessionTransferCall=null,this.emit("transferCompleted",e));break;case"o_ect_failed":case"i_ect_failed":e.session==this.sipSessionCall&&(a.info("Call transfer failed"),this.emit("transferFailed",e));break;case"o_ect_notify":case"i_ect_notify":e.session==this.sipSessionCall&&(txtCallStatus.innerHTML="<i>Call Transfer: <b>"+e.getSipResponseCode()+" "+e.description+"</b></i>",e.getSipResponseCode()>=300&&(this.sipSessionCall.bHeld&&this.sipSessionCall.resume(),btnTransfer.disabled=!1));break;case"i_ect_requested":if(e.session==this.sipSessionCall){let t="Do you accept call transfer to ["+e.getTransferDestinationFriendlyName()+"]?";if(confirm(t)){txtCallStatus.innerHTML="<i>Call transfer in progress...</i>",this.sipSessionCall.acceptTransfer();break}this.sipSessionCall.rejectTransfer()}}}}r.utils=o,r.Log=a;t.default=r}]).default});